---
title: "Journal (reproducible report)"
author: "Lars Behrendt"
date: "2020-12-01"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    toc_depth: 3
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=TRUE)
```

**IMPORTANT:** You can delete everything in here and start fresh. You might want to start by not deleting anything above this line until you know what that stuff is doing.



# Challenge 1 - Bike Sales Analysis
Last compiled: `r Sys.Date()`

The goal of the first challenge is to analyze the sales data of bike manufacturer Canyon for bikes sold in Germany. Two different aspects are of interest: first the sales by state and secondly the sales by state and year.

## Loading Librarys
First the libraries used for this challenge need to be loaded. In this case the whole tidyverse, readxl for file operations with the excel data and lubridate are loaded.

```{r eval=TRUE, include = TRUE, message = FALSE,warning=FALSE}
# 1.0 Load libraries ----
library(tidyverse)
library(readxl) # for Excel Data
library(lubridate)
```

## Importing the Sales Data
The Sales data is stored in Excel files. the library readxl is used to import the data. The data is loaded as a tibble.
```{r eval=TRUE, include = TRUE, message = FALSE,warning=FALSE}
# 2.0 Importing Files ----
bikes <- read_excel("J:/OneDrive/Studium/Masterstudium/DataScience/DS_101/00_data/01_bike_sales/01_raw_data/bikes.xlsx")
bikeshops <- read_excel("J:/OneDrive/Studium/Masterstudium/DataScience/DS_101/00_data/01_bike_sales/01_raw_data/bikeshops.xlsx")
orderlines <- read_excel("J:/OneDrive/Studium/Masterstudium/DataScience/DS_101/00_data/01_bike_sales/01_raw_data/orderlines.xlsx")
```

## Preparing Data 
After Import the sales data must be prepared for the analysis. First the data of the individual files needs to be joined together into one big tibble. The link between the datasets is done via their primary keys. After that the data is wrangled in the way needed for the analysis.
```{r eval=TRUE, include = TRUE, message = FALSE,warning=FALSE}
# 3.0 Joining Data ----
bikeData <- orderlines %>% left_join(bikes, by = c("product.id"="bike.id")) %>% left_join(bikeshops, by = c("customer.id" = "bikeshop.id"))

# 4.0 Wrangling Data ----

#Splitting category into individual sub categories
bikeData_Wrangled <- bikeData %>% separate(col= category,into = c("category.1", "category.2", "category.3"), sep =" - ") %>% 
  #Add total price
  mutate(total.price =price * quantity) %>% 
  select(-...1, -gender) %>%
  select(order.id, contains("order"), contains("model"), contains("category"),
         price, quantity, total.price,
         everything()) %>%
  set_names(names(.) %>% str_replace_all("\\.", "_"))

#Splitting Location into City and State
bikeData_Wrangled_challenge <- bikeData_Wrangled %>% separate(col = location, sep=",", into = c("city", "state")) 

```

## Analysis of the Sales Data
Now the data is ready to be analyzed. From the big tibble, which contains all the sales data, the needed information are selected and grouped according to the investigated aspect of interest.

### Sales by location
Fist the sales by location are analyzed.

```{r eval=TRUE, include = TRUE, message = FALSE,warning=FALSE}
# 5.0 Business Insights ----

# 5.1 Sales by Location ----

# Manipulate Data
salesbyLocation <- bikeData_Wrangled_challenge %>% mutate(year = year(order_date)) %>% select(year,total_price,state) %>% group_by(state) %>%
  summarise(sales = sum(total_price)) %>% mutate(sales_text = scales::dollar(sales, big.mark = ".", 
                                                                             decimal.mark = ",", 
                                                                             prefix = "", 
                                                                             suffix = " €"))
salesbyLocation
```
The results are then visualized.

```{r plot, fig.width=10, fig.height=7}
# Visualize Sales by Location
salesbyLocation %>% ggplot(aes(x = state, y=sales)) +
  geom_col(fill = "#00cccc") +
  geom_label(aes(label = sales_text)) +
  scale_y_continuous(labels = scales::dollar_format(big.mark = ".", 
                                                    decimal.mark = ",", 
                                                    prefix = "", 
                                                    suffix = " €")) +
  labs(
    title    = "Revenue by state",
    x = "", # Override defaults for x and y
    y = "Revenue"
  ) + theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
One can clearly see that there are huge differences in sales revenues across the different states in Germany. By far the largest revenue was created in North-Rhine-Westphalia. Despite being one of the smaller states, Bremen has a very high revenue as well. Especially if you compare Bremen with the other city-states Hamburg and Berlin. Berlins revenue seems to be rather low considering the huge population of Berlin.

### Sales by location and year
The procedure for the second analysis is the same as before. Starting with manipulating the data in the way needed:
```{r eval=TRUE, include = TRUE, message = FALSE,warning=FALSE}

# 5.2 sales by location and year ----

#manipulate Data
salesByLocationAndYear <- bikeData_Wrangled_challenge %>% mutate(year = year(order_date)) %>% select(year,total_price,state) %>% group_by(state,year) %>%
  summarise(sales = sum(total_price)) %>% mutate(sales_text = scales::dollar(sales, big.mark = ".", 
                                                                             decimal.mark = ",", 
                                                                             prefix = "", 
                                                                             suffix = " €"))
salesByLocationAndYear
```

The results can than be visualized:

```{r plot2, fig.width=10, fig.height=7}

#Visualize sales by location and year
salesByLocationAndYear %>%  ggplot(aes(x = year, y=sales, fill= state)) +
  geom_col() +
  facet_wrap(~state) +
  scale_y_continuous(labels = scales::dollar_format(big.mark = ".", 
                                                    decimal.mark = ",", 
                                                    prefix = "", 
                                                    suffix = " €")) +
  labs(
    title    = "Revenue by year and state",
    x = "Year", # Override defaults for x and y
    y = "Revenue",
    fill = "state"
  ) + theme(legend.position = "bottom") +
  geom_smooth(method = "lm" , se = F) # adding trendline

```

The results show that in most states the revenue has an upward trend. In some states revenue is stagnating or decreasing slightly.


# My second post (note the order)

Last compiled: `r Sys.Date()`

I'm writing this tutorial going from the top down. And, this is how it will be printed. So, notice the second post is second in the list. If you want your most recent post to be at the top, then make a new post starting at the top. If you want the oldest first, do, then keep adding to the bottom

# Adding R stuff

So far this is just a blog where you can write in plain text and serve your writing to a webpage. One of the main purposes of this lab journal is to record your progress learning R. The reason I am asking you to use this process is because you can both make a website, and a lab journal, and learn R all in R-studio. This makes everything really convenient and in the same place. 

So, let's say you are learning how to make a histogram in R. For example, maybe you want to sample 100 numbers from a normal distribution with mean = 0, and standard deviation = 1, and then you want to plot a histogram. You can do this right here by using an r code block, like this:

```{r}
samples <- rnorm(100, mean=0, sd=1)
hist(samples)
```

When you knit this R Markdown document, you will see that the histogram is printed to the page, along with the R code. This document can be set up to hide the R code in the webpage, just delete the comment (hashtag) from the cold folding option in the yaml header up top. For purposes of letting yourself see the code, and me see the code, best to keep it the way that it is. You'll learn that all of these things and more can be customized in each R code block.